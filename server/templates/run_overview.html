<div style="margin-bottom: 2rem;">
	<h2>Notes</h2>
	<form action="/api/runs/notes" method="POST">
		<input type="hidden" name="run_uuid" value="{{.UUID}}">
		<textarea name="notes" rows="4" style="width: 100%; max-width: 600px; font-family: inherit; padding: 8px;">{{.Notes}}</textarea>
		<br>
		<button type="submit" style="margin-top: 8px; padding: 6px 16px;">Save</button>
	</form>
</div>

<div style="display: flex; gap: 2rem; align-items: flex-start; max-width: 100%;">
	<div style="flex: 0 0 40%; min-width: 0;">
		{{if .Parameters}}
		<h2>Parameters</h2>
		<table border="1" cellpadding="5" cellspacing="0">
			<thead>
				<tr>
					<th>Key</th>
					<th>Value</th>
					<th>Type</th>
				</tr>
			</thead>
			<tbody>
			{{range .Parameters}}
				<tr>
					<td>{{.Key}}</td>
					<td>{{.Value}}</td>
					<td>{{.Type}}</td>
				</tr>
			{{end}}
			</tbody>
		</table>
		{{end}}
	</div>
	<div style="flex: 0 0 60%; min-width: 0; padding-right: 2rem;">
		<h2>Metrics</h2>
		<table border="1" cellpadding="5" cellspacing="0">
			<thead>
				<tr>
					<th>Key</th>
					<th>Chart</th>
					<th>Values</th>
				</tr>
			</thead>
			<tbody>
			{{range $idx, $metric := .Metrics}}
				<tr>
					<td>{{$metric.Key}}</td>
					<td style="padding: 4px">
						<canvas id="chart-{{$idx}}" width="400" height="120"></canvas>
					</td>
					<td>
						{{range $i, $v := $metric.Values}}{{if lt $i 3}}{{if $i}}, {{end}}{{$v.YValue}}{{end}}{{end}}{{if gt (len $metric.Values) 3}}...{{end}}
					</td>
				</tr>
			{{end}}
			</tbody>
		</table>
	</div>
</div>
<div id="metrics-chart-container" data-metrics='[
	{{range $idx, $metric := .Metrics}}{{if $idx}},{{end}}
	{
		"labels": [{{range $i, $v := $metric.Values}}{{if $i}}, {{end}}{{$v.XValue}}{{end}}],
		"values": [{{range $i, $v := $metric.Values}}{{if $i}}, {{end}}{{$v.YValue}}{{end}}]
	}
	{{end}}
]' style="display: none;"></div>

<script>
	(function() {
		// Format numbers to max 3 significant figures
		function formatSigFigs(value, index, ticks) {
			if (value == 0) return '0';
			return value.toPrecision(3);
		}

		// Get metric data from data attribute
		const container = document.getElementById('metrics-chart-container');
		const metricData = JSON.parse(container.dataset.metrics);

		// Create sparkline charts for each metric
		for (let i = 0; i < metricData.length; i++) {
			const ctx = document.getElementById('chart-' + i).getContext('2d');
			const data = metricData[i];

			new Chart(ctx, {
				type: 'line',
				data: {
					labels: data.labels,
					datasets: [{
						data: data.values,
						borderColor: '#0066cc',
						borderWidth: 1.5,
						pointRadius: 0,
						fill: false,
						tension: 0
					}]
				},
				options: {
					layout: {
						padding: 0
					},
					responsive: false,
					maintainAspectRatio: false,
					plugins: {
						legend: { display: false },
						tooltip: { enabled: false }
					},
					scales: {
						x: {
							type: 'linear',
							display: true,
							ticks: {
								font: { size: 12 },
								maxTicksLimit: 4,
								padding: 0,
								callback: formatSigFigs
							},
							grid: { display: false }
						},
						y: {
							display: true,
							ticks: {
								font: { size: 12 },
								maxTicksLimit: 3,
								padding: 0,
								callback: formatSigFigs
							},
							grid: { color: '#f0f0f0' }
						}
					}
				}
			});
		}
	})();
</script>
